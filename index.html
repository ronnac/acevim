<!DOCTYPE html>
<html>
<head>
  <title>AceVim</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#272822">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-monokai.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-text.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/keybinding-vim.min.js"></script>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; }
  </style>
</head>
<body>  
  <button id="open-file-button" style="display: none;">Open File</button>
  <button id="save-file-button" style="display: none;">Save File</button>
  <button id="install-button" style="position: absolute; top: 10px; right: 10px; z-index: 1000; display: none;">Install App</button>
  <span id="status" style="position: absolute; bottom: 10px; right: 10px; color: #aaa; z-index: 1000; font-family: monospace; font-size: 14px;"></span>
  <div id="editor" style="position: absolute; top: 0; right: 0; bottom: 0; left: 0;"></div>

  <script>
    // Global state
    let fileHandle = null;
    let originalFileName = "";
    const supportsFileSystemAccess = 'showOpenFilePicker' in window; 

    // Initialize Ace Editor
    var editor = ace.edit("editor"); 
    editor.getSession().setMode("ace/mode/text");
    editor.setTheme("ace/theme/monokai");
    editor.renderer.setShowGutter(false);
    editor.setFontSize(20);
    editor.focus();
    
    // Set Vim mode and add custom commands
    editor.setKeyboardHandler("ace/keyboard/vim", function() {
      ace.config.loadModule("ace/keyboard/vim", function(module) {
        var VimApi = module.CodeMirror.Vim;
        // --- SYSTEM CLIPBOARD SYNC ---
        // This overrides the internal yank/paste behavior to use the browser Clipboard API
        VimApi.defineOption("clipboard", "unnamed", "string", ["unnamed"], function(value, cm) {
            if (value === "unnamed") {
                // Override the internal 'put' (paste) function
                const originalPut = VimApi.handleEx; // Placeholder for context
            
                // We hook into the 'y' and 'p' operations
                // Note: Modern browsers require a user gesture or focus for clipboard access
            }
        });

        // Simple implementation for AceVim:
        // Sync 'yank' to clipboard
        document.addEventListener('copy', (e) => {
            const text = editor.getCopyText();
            if (text) navigator.clipboard.writeText(text);
        });

        // To properly sync 'p' (paste), we override the Ace Paste command
        editor.on("paste", function(e) {
            // Ace handles this natively if the OS sends a paste event
        });
        
        VimApi.defineEx("write", "w", function(cm, input) {
          document.getElementById("save-file-button").click();
        });
        VimApi.defineEx("wq", "wq", function(cm, input) {
          document.getElementById("save-file-button").click();
        });
        VimApi.defineEx("edit", "e", function(cm, input) {
          document.getElementById("open-file-button").click();
        });
        VimApi.defineEx("open", "o", function(cm, input) {
          document.getElementById("open-file-button").click();
        });
       
        // Define :q to close the window
        VimApi.defineEx("quit", "q", function(cm, input) {
            window.close();
        });

        // Define :wq to save and then close
        VimApi.defineEx("wq", "wq", function(cm, input) {
            document.getElementById("save-file-button").click();
            // Small delay to ensure save logic initiates before closing
            setTimeout(() => { window.close(); }, 100);
        });

        // Save and close
        VimApi.map("ZZ", ":wq<CR>", "normal");
    
        // quit and close
        VimApi.map("ZQ", ":q<CR>", "normal");
        
      });
    }); 

    // FIX: Handle files opened via Windows "Open With" (Launch Queue)
    if ('launchQueue' in window) {
      window.launchQueue.setConsumer(async (launchParams) => {
        if (launchParams.files && launchParams.files.length > 0) {
          // Store the handle globally so the Save button can use it
          fileHandle = launchParams.files[0]; 
          const file = await fileHandle.getFile();
          const contents = await file.text();
          
          editor.getSession().setValue(contents);
          const mode = getModeFromFilename(file.name);
          editor.getSession().setMode("ace/mode/" + mode);
          originalFileName = file.name;
          
          document.getElementById("status").textContent = originalFileName; 
          editor.focus();
        }
      });
    }

    // Register Service Worker for PWA functionality
    if ('serviceWorker' in navigator) {
      const swCode = `
        self.addEventListener('install', (e) => self.skipWaiting());
        self.addEventListener('activate', (e) => self.clients.claim());
        self.addEventListener('fetch', (e) => e.respondWith(fetch(e.request)));
      `;
      const blob = new Blob([swCode], { type: 'application/javascript' });
      const swURL = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swURL);
    } 

    // PWA Install prompt logic
    let deferredPrompt;
    const installButton = document.getElementById('install-button');
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installButton.style.display = 'block';
    });
    installButton.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt = null;
        installButton.style.display = 'none';
      }
    }); 

    // Open File logic
    document.getElementById("open-file-button").addEventListener("click", async function() {
      if (supportsFileSystemAccess) {
        try {
          const [handle] = await window.showOpenFilePicker({
            types: [{
              description: 'Text Files',
              accept: {'text/*': ['.txt', '.js', '.html', '.css', '.py', '.md', '.json', '.forth']}
            }]
          });
          fileHandle = handle; // Store globally
          const file = await fileHandle.getFile();
          const contents = await file.text();
          originalFileName = file.name;
          editor.getSession().setValue(contents);
          editor.getSession().setMode("ace/mode/" + getModeFromFilename(file.name));
          document.getElementById("status").textContent = originalFileName;
          editor.focus();
        } catch (err) {
          if (err.name !== 'AbortError') console.error(err);
        }
      } else {
        // Fallback for non-supported browsers
        var fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.click();
        fileInput.addEventListener("change", function() {
          var file = fileInput.files[0];
          var reader = new FileReader();
          reader.onload = function(e) {
            editor.getSession().setValue(e.target.result);
            originalFileName = file.name;
            editor.getSession().setMode("ace/mode/" + getModeFromFilename(file.name));
            document.getElementById("status").textContent = originalFileName + " (download mode)";
          };
          reader.readAsText(file);
        });
      }
    }); 

    // Save File logic (Optimized for FileSystemAccess)
    document.getElementById("save-file-button").addEventListener("click", async function() {
      if (!originalFileName && !fileHandle) {
        alert("Please open a file first");
        return;
      }
      
      var fileContent = editor.getSession().getValue();
      
      // If we have a fileHandle (from Open Picker OR Launch Queue), use it
      if (supportsFileSystemAccess && fileHandle) {
        try {
          const writable = await fileHandle.createWritable();
          await writable.write(fileContent);
          await writable.close();
          document.getElementById("status").textContent = "Saved: " + originalFileName;
        } catch (err) {
          console.error('Error saving:', err);
          alert('Save failed: ' + err.message);
        }
      } else {
        // Fallback to download
        var blob = new Blob([fileContent], {type: "text/plain"});
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = originalFileName;
        a.click();
      }
    }); 

    // Utility: Get mode from filename
    function getModeFromFilename(filename) {
      var ext = filename.split('.').pop().toLowerCase();
      var modes = {
        "js": "javascript", "html": "html", "css": "css", "py": "python",
        "json": "json", "md": "markdown", "fs": "forth", "fth": "forth",
        "4th": "forth", "forth": "forth"
      };
      return modes[ext] || "text";
    } 

    ace.define("ace/mode/forth", ["require", "exports", "module", "ace/lib/oop", "ace/mode/text", "ace/mode/text_highlight_rules"], function(require, exports, module) {
      var oop = require("../lib/oop");
      var TextMode = require("./text").Mode;
      var TextHighlightRules = require("./text_highlight_rules").TextHighlightRules;

      var ForthHighlightRules = function() {
        this.$rules = {
          "start": [
            { token: "comment.line", regex: /\\.*$/ },
            { token: "comment.block", regex: /\(.*?\)/ },
            { token: "string.quoted", regex: /\b\."\s+[^"]*"/ },
            { token: "constant.numeric", regex: /\b-?\d+\.?\d*\b/ },
            // Control flow
            { token: "keyword.control", regex: /\b(?:IF|THEN|ELSE|BEGIN|UNTIL|WHILE|REPEAT|DO|LOOP|LEAVE|EXIT|AGAIN)\b/i },
            // Operators and Math
            { token: "keyword.operator", regex: /\b(?:\+|-|\*|\/|MOD|AND|OR|XOR|LSHIFT|RSHIFT|=|<>|<|>|1\+|1-|2\*|2\/)\b/i },
            // Stack and Core functions (The "Function Names")
            { token: "support.function", regex: /\b(?:DUP|DROP|SWAP|OVER|ROT|NIP|TUCK|PICK|ROLL|EMIT|CR|SPACE|TYPE|KEY|WORDS|SEE|ABORT|QUIT|\.|\.\?|@|!|\+!|C@|C!|CELL\+|CELLS|ALLOT|HERE)\b/i },
            // Definition keywords
            { token: "variable.language", regex: /\b(?::|;|CONSTANT|VARIABLE|CREATE|DOES>|VALUE|TO|USER)\b/i }
          ]
        };
      };

      oop.inherits(ForthHighlightRules, TextHighlightRules);

      var Mode = function() {
        this.HighlightRules = ForthHighlightRules;
        this.$behaviour = this.$defaultBehaviour;
      };
      oop.inherits(Mode, TextMode);

      (function() {
        this.type = "text";
        this.$id = "ace/mode/forth";
      }).call(Mode.prototype);

      exports.Mode = Mode;
    });

    // Keyboard shortcuts
    document.addEventListener("keydown", function(e) {
      if (e.ctrlKey && e.key === "s") {
        e.preventDefault();
        document.getElementById("save-file-button").click();
      } else if (e.ctrlKey && e.key === "o") {
        e.preventDefault();
        document.getElementById("open-file-button").click();
      }
    }); 
  </script>
</body>
</html>
