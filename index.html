<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AceVim</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#272822">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-monokai.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/keybinding-vim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-forth.min.js"></script>
  
  <style>
    body { margin: 0; padding: 0; overflow: hidden; background-color: #272822; color: #f8f8f2; }
    #editor { position: absolute; top: 0; right: 0; bottom: 0; left: 0; }
    #status { position: absolute; bottom: 10px; right: 10px; color: #75715e; z-index: 1000; font-family: monospace; font-size: 14px; pointer-events: none; }
    .ace_editor .ace_cursor { border-left: 2px solid #f8f8f2 !important; }
    .normal-mode .ace_cursor { background-color: rgba(248, 248, 242, 0.5) !important; border: none !important; opacity: 0.8; }
  </style>
</head>
<body>  
  <button id="open-file-button" style="display: none;">Open</button>
  <button id="save-file-button" style="display: none;">Save</button>
  <span id="status"></span>
  <div id="editor"></div>

  <script>
    let fileHandle = null;
    let originalFileName = "";
    const supportsFileSystemAccess = 'showOpenFilePicker' in window;

    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.renderer.setShowGutter(true); 
    editor.setOption("showPrintMargin", false);
    editor.setShowLineNumbers(false);
    editor.setFontSize(18);
    
    // Initialize Vim mode
    editor.setKeyboardHandler("ace/keyboard/vim");
    
    setTimeout(() => { editor.focus(); }, 100);

    // 1. VIM & SYSTEM CLIPBOARD SYNC
    ace.config.loadModule("ace/keyboard/vim", function(module) {
        var VimApi = module.CodeMirror.Vim;

        // Sync Yank (yy, yw, etc.) to System Clipboard
        var rc = VimApi.getRegisterController();
        var originalPushText = rc.pushText;
        rc.pushText = function(registerName, operator, text, linewise, blockwise) {
            if (text && (!registerName || registerName === '"' || registerName === '*' || registerName === '+')) {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).catch(err => console.error("Clipboard write failed", err));
                }
            }
            return originalPushText.apply(this, arguments);
        };

        // Sync Paste (p) from System Clipboard
        VimApi.defineAction("pasteFromSystem", function(cm) {
            navigator.clipboard.readText().then(text => {
                if (text) { editor.insert(text); }
            }).catch(err => console.error("Clipboard read failed", err));
        });
        VimApi.mapCommand("p", "action", "pasteFromSystem", {}, { context: "normal" });

        // EX Commands
        VimApi.defineEx("write", "w", function() { document.getElementById("save-file-button").click(); });
        VimApi.defineEx("quit", "q", function() { window.close(); });
        VimApi.defineEx("wq", "wq", function() { 
            document.getElementById("save-file-button").click();
            setTimeout(() => { window.close(); }, 150);
        });
        VimApi.defineEx("edit", "e", function() { document.getElementById("open-file-button").click(); });
        VimApi.defineEx("open", "o", function() { document.getElementById("open-file-button").click(); });

        VimApi.map("ZZ", ":wq<CR>", "normal");
        VimApi.map("ZQ", ":q<CR>", "normal");
    });

    // 2. FILE MANAGEMENT
    async function handleFileEntry(handleOrFile) {
      let file;
      if (handleOrFile.getFile) {
        fileHandle = handleOrFile;
        file = await fileHandle.getFile();
      } else {
        file = handleOrFile;
        fileHandle = null; 
      }
      const contents = await file.text();
      editor.getSession().setValue(contents);
      originalFileName = file.name;
      
      // Set mode using built-in Ace logic
      const mode = getModeFromFilename(file.name);
      editor.getSession().setMode("ace/mode/" + mode);
      
      document.getElementById("status").textContent = originalFileName;
      setTimeout(() => { editor.focus(); }, 10);
    }

    document.getElementById("open-file-button").addEventListener("click", async () => {
      if (supportsFileSystemAccess) {
        try {
          const [handle] = await window.showOpenFilePicker();
          handleFileEntry(handle);
        } catch (e) {}
      } else {
        const input = document.createElement('input');
        input.type = 'file';
        input.onchange = e => handleFileEntry(e.target.files[0]);
        input.click();
      }
    });

    const container = document.getElementById("editor");
    container.addEventListener("dragover", e => { e.preventDefault(); e.dataTransfer.dropEffect = "copy"; });
    container.addEventListener("drop", async e => {
      e.preventDefault();
      const item = e.dataTransfer.items[0];
      if (item && item.kind === 'file') {
        if (typeof item.getAsFileSystemHandle === 'function') {
          handleFileEntry(await item.getAsFileSystemHandle());
        } else {
          handleFileEntry(e.dataTransfer.files[0]);
        }
      }
    });

    if ('launchQueue' in window) {
      window.launchQueue.setConsumer(async (launchParams) => {
        if (launchParams.files && launchParams.files.length > 0) {
          handleFileEntry(launchParams.files[0]);
        }
      });
    }

    document.getElementById("save-file-button").addEventListener("click", async function() {
      if (!fileHandle) {
          if (originalFileName) {
              const blob = new Blob([editor.getValue()], {type: "text/plain"});
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url; a.download = originalFileName; a.click();
          }
          return;
      }
      try {
        const writable = await fileHandle.createWritable();
        await writable.write(editor.getValue());
        await writable.close();
        document.getElementById("status").textContent = "Saved: " + originalFileName;
      } catch (e) { console.error(e); }
    });

    function getModeFromFilename(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const modes = { 
          "js":"javascript", "py":"python", "fs":"forth", 
          "fth":"forth", "forth":"forth", "html":"html", 
          "css":"css", "json":"json", "md":"markdown" 
      };
      return modes[ext] || "text";
    }

    if ('serviceWorker' in navigator) {
      const sw = `self.addEventListener('fetch', e => e.respondWith(fetch(e.request)));`;
      const blob = new Blob([sw], {type: 'text/javascript'});
      navigator.serviceWorker.register(URL.createObjectURL(blob));
    }
  </script>
</body>
</html>
