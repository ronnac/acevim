<!DOCTYPE html>
<html>
<head>
  <title>AceVim</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#272822">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-monokai.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/keybinding-vim.min.js"></script>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; background-color: #272822; color: #f8f8f2; }
    #editor { position: absolute; top: 0; right: 0; bottom: 0; left: 0; }
    #status { position: absolute; bottom: 10px; right: 10px; color: #75715e; z-index: 1000; font-family: monospace; font-size: 14px; pointer-events: none; }
    
    .ace_editor .ace_cursor { border-left: 2px solid #f8f8f2 !important; }
    .normal-mode .ace_cursor { background-color: rgba(248, 248, 242, 0.5) !important; border: none !important; opacity: 0.8; }
  </style>
</head>
<body>  
  <button id="open-file-button" style="display: none;">Open</button>
  <button id="save-file-button" style="display: none;">Save</button>
  <span id="status"></span>
  <div id="editor"></div>

  <script>
    let fileHandle = null;
    let originalFileName = "";
    const supportsFileSystemAccess = 'showOpenFilePicker' in window;

    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.renderer.setShowGutter(false); 
    editor.setOption("showPrintMargin", false);
    editor.setFontSize(18);
    
    setTimeout(() => { editor.focus(); }, 100);

    // 1. Forth Syntax
    ace.define("ace/mode/forth", ["require","exports","module","ace/lib/oop","ace/mode/text","ace/mode/text_highlight_rules"], function(require, exports, module) {
      var oop = require("../lib/oop");
      var TextMode = require("./text").Mode;
      var TextHighlightRules = require("./text_highlight_rules").TextHighlightRules;
      var ForthHighlightRules = function() {
        this.$rules = {
          "start": [
            { token: "comment.line", regex: /\\.*$/ },
            { token: "comment.block", regex: /\(.*?\)/ },
            { token: "string.quoted", regex: /\b\."\s+[^"]*"/ },
            { token: "string.quoted", regex: /s"\s+[^"]*"/i },
            { token: "constant.numeric", regex: /\b-?\d+\.?\d*\b/ },
            { token: "constant.numeric", regex: /\$[0-9A-Fa-f]+/ },
            { token: "keyword.control", regex: /\b(?:IF|THEN|ELSE|BEGIN|UNTIL|WHILE|REPEAT|DO|LOOP|\+LOOP|LEAVE|EXIT|AGAIN|RECURSE|CASE|OF|ENDOF|ENDCASE)\b/i },
            { token: "keyword.operator", regex: /\b(?:\+|-|\*|\/|MOD|\/MOD|\*\/MOD|AND|OR|XOR|NOT|LSHIFT|RSHIFT|=|<>|<|>|<=|>=|0=|0<|0>|1\+|1-|2\*|2\/)\b/i },
            { token: "support.function", regex: /\b(?:DUP|DROP|SWAP|OVER|ROT|NIP|TUCK|PICK|ROLL|2DUP|2DROP|2SWAP|2OVER|>R|R>|R@|EMIT|CR|SPACE|SPACES|TYPE|KEY|WORDS|SEE|ABORT|QUIT|\.|\.\?|@|!|\+!|C@|C!|2@|2!|CELL\+|CELLS|ALLOT|HERE|CHAR|CHARS)\b/i },
            { token: ["variable.language", "text", "entity.name.function"], regex: /(^|\s)(:)(\s+\S+)/ },
            { token: "variable.language", regex: /\b(?:;|CONSTANT|VARIABLE|CREATE|DOES>|VALUE|TO|USER|MARKER)\b/i }
          ]
        };
      };
      oop.inherits(ForthHighlightRules, TextHighlightRules);
      var Mode = function() { this.HighlightRules = ForthHighlightRules; };
      oop.inherits(Mode, TextMode);
      exports.Mode = Mode;
    });

    // 2. VIM & CLIPBOARD SYNC (The Fix)
    editor.setKeyboardHandler("ace/keyboard/vim", function() {
      ace.config.loadModule("ace/keyboard/vim", function(module) {
        var VimApi = module.CodeMirror.Vim;

        // YANK: Vim -> System
        editor.on("copy", function(text) {
          if (text) navigator.clipboard.writeText(text);
        });

        // PASTE: System -> Vim (Intercepting the 'p' key in Normal mode)
        const originalHandleKey = editor.keyBinding.onCommandKey;
        editor.keyBinding.onCommandKey = function(e, hashId, keyCode) {
            // If 'p' is pressed in normal mode
            if (keyCode === 80 && !editor.state.cm.state.vim.insertMode) {
                navigator.clipboard.readText().then(text => {
                    if (text) {
                        const pos = editor.getCursorPosition();
                        editor.session.insert(pos, text);
                    }
                });
                return; 
            }
            return originalHandleKey.apply(this, arguments);
        };

        // EX Commands
        VimApi.defineEx("write", "w", function() { document.getElementById("save-file-button").click(); });
        VimApi.defineEx("quit", "q", function() { window.close(); });
        VimApi.defineEx("wq", "wq", function() { 
            document.getElementById("save-file-button").click();
            setTimeout(() => { window.close(); }, 150);
        });
        VimApi.defineEx("edit", "e", function() { document.getElementById("open-file-button").click(); });
        VimApi.defineEx("open", "o", function() { document.getElementById("open-file-button").click(); });

        VimApi.map("ZZ", ":wq<CR>", "normal");
        VimApi.map("ZQ", ":q<CR>", "normal");
      });
    });

    // 3. File Handlers
    async function handleFileEntry(handleOrFile) {
      let file;
      if (handleOrFile.getFile) {
        fileHandle = handleOrFile;
        file = await fileHandle.getFile();
      } else {
        file = handleOrFile;
        fileHandle = null; 
      }
      const contents = await file.text();
      editor.getSession().setValue(contents);
      originalFileName = file.name;
